# Story 4.2: Barcode Generation for Shipments

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As the **System**,
I want to **generate a unique barcode for each shipment**,
so that **it can be tracked throughout the delivery process**.

## Acceptance Criteria

1. **Given** a shipment is created
   **When** the shipment is saved
   **Then** a unique barcode is generated (format: `BD-2025-XXXXX`)
2. **And** the barcode is displayed on the shipment details page
3. **And** a printable barcode image is available for download (generated by backend)
4. **And** legacy barcodes (if any) are supported or migrated (optional for MVP - specific note: MVP assumes new data)

## Tasks / Subtasks

- [x] Backend: Install Barcode Library (AC: #3)
  - [x] Install `bwip-js` (npm install bwip-js).
- [x] Backend: Implement Barcode Logic in `ShipmentsService` (AC: #1)
  - [x] Create private helper `generateBarcode()`: Format `BD-2025-{clean_random_string}`.
  - [x] Ensure uniqueness (check DB before assigning, retry if collision).
  - [x] Update `create` and `createFromPrediction` to use this helper.
- [x] Backend: Create Barcode Image Endpoint (AC: #3)
  - [x] Add `GET /shipments/:id/barcode` to `ShipmentsController`.
  - [x] In `ShipmentsService`, use `bwip-js.toBuffer` to generate PNG of the barcode string.
  - [x] Return image buffer with correct content-type (`image/png`).
- [x] Frontend: Display Barcode (AC: #2, #3)
  - [x] Update `TrackPage` component.
  - [x] Display the text barcode (e.g., `BD-2025-A7F9K`).
  - [x] Add "Download Barcode" button that links to `/api/shipments/:id/barcode`.
  - [x] Display the barcode image directly on page.

## Dev Notes

### Architecture Patterns
- **Library**: `bwip-js` is standard for Node.js barcode generation.
- **Service Layer**: Logic belongs in `ShipmentsService`.
- **Controller**: New endpoint matches REST pattern (`GET /shipments/:id/barcode`).
- **Uniqueness**: Random 5-char alphanumeric string with DB check and retry loop (max 5 attempts).

### Project Structure Notes
- **ShipmentsModule**: Continue using existing module.
- **Frontend**: `frontend/src/pages/public/TrackPage/TrackPage.tsx`.

### References
- [Epic 4 - Story 4.2](file:///Users/omerfarukkizil/development/BlokDepremProject/_bmad-output/epics.md#L494)
- Current simple implementation: `backend/src/modules/shipments/shipments.service.ts` (uses `SHIP-{timestamp}`)

## Dev Agent Record

### Agent Model Used
Gemini (Antigravity)

### Debug Log References

### Completion Notes List
- Installed `bwip-js` library for barcode image generation
- Implemented `generateBarcode()` helper with format `BD-{year}-{5-char-alphanumeric}`
- Added uniqueness check with retry loop (max 5 attempts) to prevent collisions
- Implemented `getShipmentBarcodeImage()` using bwip-js with Code 128 format
- Added `GET /shipments/:id/barcode` endpoint returning PNG image
- Updated both `create()` and `createFromPrediction()` to use new barcode format
- Added barcode section to TrackPage with image display and download button
- All 100 backend tests pass including 2 new tests for barcode image generation

### File List
- backend/package.json (modified)
- backend/package-lock.json (modified)
- backend/src/modules/shipments/shipments.service.ts (modified)
- backend/src/modules/shipments/shipments.controller.ts (modified)
- backend/src/modules/shipments/shipments.service.spec.ts (modified)
- frontend/src/pages/public/TrackPage/TrackPage.tsx (modified)

### Change Log
- 2025-12-25: Implemented Story 4.2 - Barcode generation with BD-{year}-XXXXX format, image endpoint, and frontend display
